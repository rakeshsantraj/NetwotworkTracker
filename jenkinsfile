pipeline {
    agent any

    tools {
        jdk 'jdk17'
        maven 'maven3'
    }

    environment {
        AWS_REGION = 'ca-central-1'
        ECR_ACCOUNT = '675169530083'
        IMAGE_TAG = "${BUILD_NUMBER}"
        Git_repo = 'https://github.com/vivekgshan/Log-Processing.git'  // Update if your repo changed
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }

    stages {
        stage('Clean Workspace') {
          steps {
            deleteDir()
          }
        }

        stage('Checkout') {
            steps {
                git branch: 'devops-nikhil-test', changelog: false, poll: false, url: "${Git_repo}"
            }
        }

        stage('Build Backend Services') {
            steps {
                script {
                    def backendServices = [
                        'packetcaptureconsumerservice',
                        'packetcaptureproducerservice',
                        'packetanalyserservice',
                        'packetcaptureservice'  // Python service might not need Maven build, see note below
                    ]

                    backendServices.each { svc ->
                        if (svc == 'packetcaptureservice') {
                            // If Python service, build docker image only - no Maven
                            echo "Skipping Maven build for Python service: ${svc}"
                        } else {
                            dir("BACKEND/${svc}") {
                                sh 'mvn clean package -DskipTests'
                            }
                        }
                    }
                }
            }
        }

        stage('Create ECR Repositories') {
            steps {
                script {
                    def allRepos = [
                        'packetcaptureconsumerservice',
                        'packetcaptureproducerservice',
                        'packetanalyserservice',
                        'packetcaptureservice',
                        'frontend'
                    ]
                    allRepos.each { repo ->
                        sh """
                        aws ecr describe-repositories --repository-names ${repo} --region ${AWS_REGION} || \
                        aws ecr create-repository --repository-name ${repo} --region ${AWS_REGION}
                        """
                    }
                }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    def backendServices = [
                        'packetcaptureconsumerservice',
                        'packetcaptureproducerservice',
                        'packetanalyserservice',
                        'packetcaptureservice'  // Python service included here
                    ]
                    backendServices.each { svc ->
                        def image = "${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${svc}:${IMAGE_TAG}"
                        sh "docker build -t ${image} ${svc.toUpperCase()}"  // Assuming folder names match service names uppercase
                    }

                    def frontendImage = "${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/frontend:${IMAGE_TAG}"
                    sh "docker build -t ${frontendImage} FRONTEND"
                }
            }
        }

        stage('Login to ECR') {
            steps {
                sh """
                aws ecr get-login-password --region ${AWS_REGION} | \
                docker login --username AWS --password-stdin ${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com
                """
            }
        }

        stage('Push Images to ECR') {
            steps {
                script {
                    def services = [
                        'packetcaptureconsumerservice',
                        'packetcaptureproducerservice',
                        'packetanalyserservice',
                        'packetcaptureservice',
                        'frontend'
                    ]
                    services.each { svc ->
                        def image = "${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${svc}:${IMAGE_TAG}"
                        sh "docker push ${image}"
                    }
                }
            }
        }

        stage('Generate & Deploy Docker Compose') {
            steps {
                script {
                    def baseCompose = readFile('docker-compose.yml')

                    def services = [
                        'packetcaptureconsumerservice',
                        'packetcaptureproducerservice',
                        'packetanalyserservice',
                        'packetcaptureservice'
                    ]

                    def updatedCompose = baseCompose
                    services.each { svc ->
                        def pattern = "image:.*${svc}.*"
                        def newImage = "image: ${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${svc}:${IMAGE_TAG}"
                        updatedCompose = updatedCompose.replaceAll(pattern, newImage)
                    }

                    // Replace frontend image
                    updatedCompose = updatedCompose.replaceAll(/image:.*frontend.*/, "image: ${ECR_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/frontend:${IMAGE_TAG}")

                    writeFile file: 'docker-compose.generated.yml', text: updatedCompose

                    sh 'docker compose -f docker-compose.generated.yml down'
                    sh 'docker compose -f docker-compose.generated.yml up -d'
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
